7services:
  # PostgreSQL Database
  - type: pserv
    name: collabcanvas-db
    plan: free
    env: docker
    dockerfilePath: Dockerfile.postgres
    region: oregon
    databases:
      - name: collabcanvas
        databaseName: collabcanvas
        user: collabcanvas
        plan: free

  # HTTP Backend Service
  - type: web
    name: collabcanvas-http-backend
    runtime: node
    plan: free
    region: oregon
    buildCommand: pnpm install && pnpm --filter http-backend run build
    startCommand: cd apps/http-backend && node dist/index.js
    envVars:
      - key: NODE_ENV
        value: production
      - key: DATABASE_URL
        fromDatabase:
          name: collabcanvas
          property: connectionString
      - key: JWT_SECRET
        generateValue: true
      - key: FRONTEND_URL
        value: https://collabcanvas-frontend.onrender.com
    healthCheckPath: /health

  # WebSocket Backend Service
  - type: web
    name: collabcanvas-ws-backend
    runtime: node
    plan: free
    region: oregon
    buildCommand: pnpm install && pnpm --filter ws-backend run build
    startCommand: cd apps/ws-backend && node dist/index.js
    envVars:
      - key: NODE_ENV
        value: production
      - key: DATABASE_URL
        fromDatabase:
          name: collabcanvas
          property: connectionString
      - key: JWT_SECRET
        sync: false  # This should match the HTTP backend's JWT_SECRET

  # Frontend Static Site
  - type: web
    name: collabcanvas-frontend
    runtime: static
    buildCommand: pnpm install && cd apps/collabcanvas-landing && pnpm run build
    staticPublishPath: apps/collabcanvas-landing/dist
    envVars:
      - key: VITE_API_URL
        value: https://collabcanvas-http-backend.onrender.com
      - key: VITE_WS_URL
        value: wss://collabcanvas-ws-backend.onrender.com
    routes:
      - type: rewrite
        source: /*
        destination: /index.html
